[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
loglevel=info

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# =============================================================================
# Bun/Elysia API Server
# =============================================================================
[program:api]
command=/usr/local/bin/bun run /app/src/index.ts
directory=/app
autostart=true
autorestart=true
startsecs=3
startretries=3
stopwaitsecs=10
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=
    NODE_ENV="production",
    API_PORT="%(ENV_API_PORT)s",
    SCREENSHOT_PATH="%(ENV_SCREENSHOT_PATH)s",
    INTERNAL_API_KEY="%(ENV_INTERNAL_API_KEY)s",
    VOTE_WINDOW_DURATION_MS="%(ENV_VOTE_WINDOW_DURATION_MS)s",
    SCREENSHOT_CACHE_TTL="%(ENV_SCREENSHOT_CACHE_TTL)s"

# =============================================================================
# Python Emulator + Stream Compositor
# =============================================================================
[program:emulator]
command=/usr/local/bin/python /app/python/main.py
directory=/app
autostart=true
autorestart=true
startsecs=5
startretries=3
# Allow time for save state on shutdown
stopwaitsecs=30
stopsignal=TERM
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=
    ROM_PATH="%(ENV_ROM_PATH)s",
    SCREENSHOT_PATH="%(ENV_SCREENSHOT_PATH)s",
    SAVE_STATE_PATH="%(ENV_SAVE_STATE_PATH)s",
    LOCAL_PREVIEW_PATH="%(ENV_LOCAL_PREVIEW_PATH)s",
    API_URL="%(ENV_API_URL)s",
    INTERNAL_API_KEY="%(ENV_INTERNAL_API_KEY)s",
    RTMP_URL="%(ENV_RTMP_URL)s",
    LOCAL_PREVIEW="%(ENV_LOCAL_PREVIEW)s",
    AUDIO_VOLUME_BOOST="%(ENV_AUDIO_VOLUME_BOOST)s",
    SAVE_STATE_INTERVAL="%(ENV_SAVE_STATE_INTERVAL)s"

# =============================================================================
# Event Listener for Graceful Shutdown
# =============================================================================
[eventlistener:shutdown]
command=/bin/sh -c "while read line; do supervisorctl shutdown; done"
events=PROCESS_STATE_FATAL
buffer_size=100
