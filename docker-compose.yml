services:
  rtmp:
    image: bluenviron/mediamtx:latest
    ports:
      - "1935:1935"
      - "8554:8554"
      - "8888:8888"

  emulator:
    build: ./emulator
    depends_on:
      - rtmp
    environment:
      - DISPLAY=:99
      - SDL_VIDEODRIVER=x11
      - SDL_AUDIODRIVER=dummy
      - RTMP_URL=rtmp://rtmp:1935/live/stream
    volumes:
      - ./roms:/roms:ro
    ports:
      - "55355:55355/udp"
      - "55400:55400"

  api:
    build: .
    depends_on:
      - rtmp
      - emulator
    environment:
      - API_PORT=3000
      - EMULATOR_HOST=emulator
      - EMULATOR_MEMORY_PORT=55355
      - EMULATOR_INPUT_PORT=55400
      - RTMP_URL=rtmp://rtmp:1935/live/stream
      - SCREENSHOT_FETCH_INTERVAL_MS=5000
      - GAMESTATE_FETCH_INTERVAL_MS=3000
      - VOTE_WINDOW_DURATION_MS=10000
      - EXECUTION_COOLDOWN_MS=5000
      - UDP_TIMEOUT_MS=2000
      - UDP_RETRIES=3
    ports:
      - "3000:3000"

  compositor:
    build: ./compositor
    depends_on:
      - rtmp
      - emulator
      - api
    environment:
      - API_URL=http://api:3000
      - INPUT_RTMP_URL=rtmp://rtmp:1935/live/stream
      - OUTPUT_RTMP_URL=${TWITCH_RTMP_URL:-}
      - STATUS_POLL_INTERVAL_MS=100
    restart: unless-stopped
